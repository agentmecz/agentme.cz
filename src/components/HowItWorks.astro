---
import SectionWrapper from './ui/SectionWrapper.astro';
import FadeIn from './ui/FadeIn.astro';
import { howItWorks } from '../data/content';

function highlightLine(line: string): string {
  let html = line
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  if (html.trimStart().startsWith('//')) {
    return `<span class="syn-comment">${html}</span>`;
  }

  html = html.replace(
    /('[^']*'|"[^"]*")/g,
    '<span class="syn-string">$1</span>'
  );

  html = html.replace(
    /\b(import|from|export|const|let|var|async|await|new|return|function|if|else)\b/g,
    '<span class="syn-keyword">$1</span>'
  );

  html = html.replace(
    /(?<!["\w])(\d+\.?\d*)(?!["\w])/g,
    '<span class="syn-number">$1</span>'
  );

  return html;
}
---

<SectionWrapper id="how-it-works">
  <FadeIn>
    <h2 class="mb-4 text-center text-3xl font-bold tracking-tight md:text-4xl lg:text-5xl">
      {howItWorks.headline}
    </h2>
    <p class="mb-16 text-center text-text-secondary max-w-2xl mx-auto">
      {howItWorks.description}
    </p>
  </FadeIn>

  <div class="space-y-8 mx-auto max-w-3xl">
    {howItWorks.steps.map((step, i) => (
      <FadeIn delay={i * 150}>
        <div class="rounded-xl border border-border bg-bg-card/30 p-6 md:p-8">
          <div class="flex items-start gap-5 mb-4">
            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full border border-border bg-bg-secondary text-sm font-bold text-accent-cyan">
              {step.number}
            </div>
            <div>
              <h3 class="text-xl font-semibold">{step.title}</h3>
              <p class="mt-1 text-sm text-text-secondary">{step.description}</p>
            </div>
          </div>
          <div class="ml-0 md:ml-15 overflow-x-auto rounded-lg bg-bg-primary border border-border p-4">
            <pre class="text-sm leading-relaxed" tabindex="0" role="region" aria-label={`Code for step ${step.number}`}><code class="font-mono text-text-secondary">{step.code.split('\n').map((line: string) => (
              <span class="code-line block" set:html={highlightLine(line) || '\u00A0'} />
            ))}</code></pre>
          </div>
        </div>
      </FadeIn>
    ))}
  </div>
</SectionWrapper>
