---
interface Props {
  code: string;
  filename?: string;
}

const { code, filename = 'index.ts' } = Astro.props;

function highlightLine(line: string): string {
  let html = line
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Full-line comment â€” highlight entire line, skip other rules
  if (html.trimStart().startsWith('//')) {
    return `<span class="syn-comment">${html}</span>`;
  }

  // Strings (single and double quoted)
  html = html.replace(
    /('[^']*'|"[^"]*")/g,
    '<span class="syn-string">$1</span>'
  );

  // Keywords
  html = html.replace(
    /\b(import|from|export|const|let|var|async|await|new|return|function|if|else)\b/g,
    '<span class="syn-keyword">$1</span>'
  );

  // Numbers (not inside already-highlighted spans)
  html = html.replace(
    /(?<!["\w])(\d+\.?\d*)(?!["\w])/g,
    '<span class="syn-number">$1</span>'
  );

  return html;
}

const lines = code.split('\n');
---

<div class="code-snippet mx-auto max-w-2xl overflow-hidden rounded-xl border border-border bg-bg-secondary">
  <!-- Window chrome -->
  <div class="flex items-center gap-2 border-b border-border px-4 py-3">
    <div class="h-3 w-3 rounded-full bg-text-muted/30" />
    <div class="h-3 w-3 rounded-full bg-text-muted/30" />
    <div class="h-3 w-3 rounded-full bg-text-muted/30" />
    <span class="ml-2 text-xs text-text-muted">{filename}</span>
  </div>

  <!-- Code -->
  <pre class="overflow-x-auto p-6 text-left" tabindex="0" role="region" aria-label="Code example"><code class="block font-mono text-sm leading-relaxed text-text-secondary">{lines.map((line) => (
    <span class="code-line block opacity-0" set:html={highlightLine(line) || '\u00A0'} />
  ))}</code></pre>
</div>

<script>
  import { animate, onScroll, stagger } from 'animejs';

  function initCodeTyping() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    document.querySelectorAll('.code-snippet').forEach((snippet) => {
      const lines = snippet.querySelectorAll<HTMLElement>('.code-line');
      if (!lines.length) return;

      if (prefersReducedMotion) {
        lines.forEach((l) => (l.style.opacity = '1'));
        return;
      }

      onScroll({
        target: snippet,
        enter: 'bottom-=100 top',
        repeat: false,
        onEnter: () => {
          animate(lines, {
            opacity: [0, 1],
            translateX: ['-8px', '0px'],
            duration: 400,
            delay: stagger(60),
            ease: 'outExpo',
          });
        },
      });
    });
  }

  initCodeTyping();
  document.addEventListener('astro:page-load', initCodeTyping);
</script>
