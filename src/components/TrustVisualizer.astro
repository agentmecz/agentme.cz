---
import SectionWrapper from './ui/SectionWrapper.astro';
import FadeIn from './ui/FadeIn.astro';
import GradientText from './ui/GradientText.astro';
import { trustScore } from '../data/content';
---

<SectionWrapper id="trust">
  <!-- GEO: extractable trust score summary for AI engines -->
  <p class="sr-only">
    AgentMesh composite trust score formula: 0.50 × reputation + 0.30 × stake + 0.20 × endorsements. Reputation is based on transaction success rate, volume, and recency, decaying 5% per 14 inactive days. Stake requires minimum $100 USDC collateral locked on-chain, slashed on dispute loss. Endorsements use a web-of-trust graph with max 3 hops and 10% decay per hop. ERC-8004 compatible.
  </p>

  <FadeIn>
    <h2 class="mb-4 text-center text-3xl font-bold tracking-tight md:text-4xl lg:text-5xl">
      <GradientText as="span">{trustScore.headline}</GradientText>
    </h2>
    <p class="mb-16 text-center text-text-secondary max-w-2xl mx-auto">
      {trustScore.description}
    </p>
  </FadeIn>

  <FadeIn>
    <div class="mx-auto max-w-lg rounded-2xl border border-border bg-bg-card/50 p-8">
      <!-- Total score -->
      <div class="mb-8 text-center">
        <div class="text-sm text-text-muted uppercase tracking-wider mb-2">Composite Trust Score</div>
        <div class="trust-counter text-6xl font-bold tabular-nums text-accent-cyan" data-target={trustScore.total}>
          <noscript>{trustScore.total.toFixed(2)}</noscript>
          <span class="trust-counter-value">0.00</span>
        </div>
      </div>

      <!-- Components -->
      <div class="space-y-6">
        {trustScore.components.map((comp) => (
          <div class="group">
            <div class="mb-1 flex items-center justify-between text-sm">
              <span class="text-text-primary font-medium">
                {comp.name}
                <span class="text-text-muted ml-1 font-normal">({comp.weight})</span>
              </span>
              <span class="trust-bar-value tabular-nums font-medium text-accent-cyan" data-target={comp.value}>0.00</span>
            </div>
            <div class="h-2 overflow-hidden rounded-full bg-bg-secondary mb-1.5">
              <div
                class="trust-bar h-full rounded-full bg-gradient-to-r from-accent-cyan to-accent-purple transition-all duration-1000 ease-out"
                data-width={comp.value * 100}
                style="width: 0%"
              />
            </div>
            <p class="text-xs text-text-muted">{comp.detail}</p>
          </div>
        ))}
      </div>

      <!-- Formula -->
      <div class="mt-6 rounded-lg bg-bg-secondary p-3 text-center font-mono text-xs text-text-muted">
        {trustScore.formula}
      </div>
    </div>
  </FadeIn>
</SectionWrapper>

<script>
  import { onScroll } from 'animejs';

  function initTrustVisualizer() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const counterWrap = document.querySelector<HTMLElement>('.trust-counter');
    const counter = document.querySelector<HTMLElement>('.trust-counter-value');
    if (!counterWrap || !counter) return;

    const target = parseFloat(counterWrap.dataset.target || '0');
    let animated = false;

    function animateValues() {
      if (animated) return;
      animated = true;

      // Counter animation
      const duration = prefersReducedMotion ? 0 : 800;
      const start = performance.now();

      function tick(now: number) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        counter!.textContent = (target * eased).toFixed(2);
        if (progress < 1) requestAnimationFrame(tick);
      }
      if (duration > 0) requestAnimationFrame(tick);
      else counter.textContent = target.toFixed(2);

      // Bars
      document.querySelectorAll<HTMLElement>('.trust-bar').forEach((bar) => {
        const w = bar.dataset.width || '0';
        if (prefersReducedMotion) {
          bar.style.width = `${w}%`;
        } else {
          setTimeout(() => (bar.style.width = `${w}%`), 200);
        }
      });

      // Bar values
      document.querySelectorAll<HTMLElement>('.trust-bar-value').forEach((el) => {
        const t = parseFloat(el.dataset.target || '0');
        if (prefersReducedMotion) {
          el.textContent = t.toFixed(2);
          return;
        }
        const s = performance.now();
        function tickVal(now: number) {
          const elapsed = now - s;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3);
          el.textContent = (t * eased).toFixed(2);
          if (progress < 1) requestAnimationFrame(tickVal);
        }
        requestAnimationFrame(tickVal);
      });
    }

    onScroll({
      target: counter,
      enter: 'bottom-=200 top',
      onEnter: animateValues,
    });
  }

  initTrustVisualizer();
  document.addEventListener('astro:page-load', initTrustVisualizer);
</script>
